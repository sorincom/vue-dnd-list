<template>
  <article
    ref="rootRef"
    @dragend="onDragEnd"
    @dragover="onDragOver"
    @dragstart="onDragStart"
    :draggable="draggable">
    <slot></slot>
  </article>
</template>

<script>

import { ref, inject } from 'vue'
import { bus } from './bus'

/// Custom drag and drop related events generated by a list item
const useDnDItemEvents = function(props, rootRef, copy, list) {

  // Item started being dragged
  function onDragStart(evt) {
    // Set effect
    const effect = copy.value ? 'copy' : 'move'
    evt.dataTransfer.dropEffect = effect
    evt.dataTransfer.effectAllowed = effect

    // Set drag image
    const rect = rootRef.value.getBoundingClientRect()
    const coords = {
      x: evt.clientX - rect.left,
      y: evt.clientY - rect.top
    }
    evt.dataTransfer.setDragImage(rootRef.value, coords.x, coords.y)

    // Emit event
    bus.emit('dnd:dragstart', {
      source: list.value,
      data: copy.value ? JSON.parse(JSON.stringify(props.item)) : props.item
    })
  }

  // Something's being dragged over this list item
  function onDragOver(evt) {
    evt.preventDefault()
    bus.emit('dnd:dragover', {
      source: list.value, index: props.index
    })
  }

  // Item stopped being dragged
  function onDragEnd(evt) {
    evt.preventDefault()
    if(evt.dataTransfer.dropEffect == 'none') {
      // dnd canceled
      bus.emit('dnd:cancel', {source: list.value})
    } else {
      // dnd finished normally
      bus.emit('dnd:dragend', {source: list.value})
    }
  }

  return {
    onDragStart,
    onDragEnd,
    onDragOver
  }
}

export default {
  name: 'DnDListItem',
  props: {
    item: {
      required: true
    },
    index: {
      required: true
    }
  },
  emits: ['dnd:drag-over'],
  setup(props) {
    const rootRef = ref(null)

    // Get injected props
    const list = inject('dnd-list', null)
    const draggable = inject('dnd-draggable', true)
    const copy = inject('dnd-copy', false)

    return {
      rootRef,
      draggable,
      ...useDnDItemEvents(props, rootRef, copy, list),
    }
  },
}

</script>
